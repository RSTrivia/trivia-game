<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script>
  (function () {
      const bg = localStorage.getItem("bg_current");
      if (bg) {
        document.documentElement.style.setProperty("--bg-image", `url('${bg}')`);
      }
    })();

  </script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OSRS Trivia</title>
  <script>
    
// Define these globally for this script
  const cachedUsername = localStorage.getItem('cachedUsername') || 'Guest';
  const cachedLoggedIn = localStorage.getItem('cachedLoggedIn') === 'true';
  const cachedMuted = localStorage.getItem('muted') === 'true';
  const todayStr = new Date().toISOString().split('T')[0];
 
  async function handleAuthAction() {
    const isLoggedIn = localStorage.getItem('cachedLoggedIn') === 'true';
    if (isLoggedIn) {
      supabase.auth.signOut(); // ğŸ”‘ THIS WAS MISSING
    } else {
      window.location.href = 'login.html';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const span = document.getElementById('usernameSpan');
    const authBtn = document.getElementById('authBtn');
    const authLabel = authBtn?.querySelector('.btn-label');
    const muteIcon = document.getElementById('muteIcon');
    const muteBtn = document.getElementById('muteBtn');
    const dailyBtn = document.getElementById('dailyBtn');
    const weeklyBtn = document.getElementById('weeklyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const logBtn = document.getElementById('logBtn');
    const lobbyBtn = document.getElementById('lobbyBtn');
    const helpBtn = document.getElementById('helpBtn');
    const helpModal = document.getElementById('help-modal');
    const closeHelpBtn = document.getElementById('closeHelpBtn');
    const levelNum = document.getElementById('levelNumber');
    const xpBracket = document.getElementById('xpBracket');
    
    const hasPlayedToday = localStorage.getItem('dailyPlayedDate') === todayStr;
    const hasScore = localStorage.getItem('lastDailyScore') !== null;

    // 1. Level & XP Calculation (Moved from bottom to here)
    if (cachedLoggedIn) {
      const cXp = parseInt(localStorage.getItem('cached_xp')) || 0;
      let dLvl = 1;
      if (cXp >= 100000) { dLvl = 99; }
      else if (cXp > 0) {
        for (let L = 1; L <= 99; L++) {
          let threshold = Math.floor(Math.pow((L - 1) / 98, 3.1) * 100000);
          if (cXp < threshold) {
            dLvl = Math.max(1, L - 1);
            break;
          }
        }
      }
      if (levelNum) levelNum.textContent = dLvl;
      if (xpBracket) xpBracket.textContent = ` (${cXp.toLocaleString()} XP)`;
    } else {
      if (levelNum) levelNum.textContent = '1';
      if (xpBracket) xpBracket.textContent = ' (0 XP)';
    }

    // 1. Reset everything to locked first (Safety)
  [dailyBtn, weeklyBtn, lobbyBtn].forEach(btn => {
    if (btn) {
        btn.classList.remove('is-active');
        btn.classList.add('is-disabled');
    }
   }); 
    // 1. Instant Text/Emoji Sync
    if (span) span.textContent = ' ' + cachedUsername;

    // --- ADD THE PET LOGIC HERE ---
    const petId = localStorage.getItem('equipped_pet_id'); // We will ensure this is saved in Step 2
    const petImg = document.getElementById('equipped-pet-display');
    
    if (petId && petId !== "null" && petImg) {
        const fileName = petId.replace('pet_', '') + '.png'; 
        petImg.src = `pets/${fileName}`;
        petImg.style.display = 'inline-block';
        petImg.style.marginLeft = '5px'; // Add a little space from the name
        petImg.style.verticalAlign = 'middle'; // Center it with the text
    } else if (petImg) {
        petImg.style.display = 'none';
    }
    // ------------------------------
    
    if (authLabel) authLabel.textContent = cachedLoggedIn ? 'Log Out' : 'Log In';

    if (muteIcon && muteBtn) {
      muteIcon.textContent = cachedMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      if (cachedMuted) muteBtn.classList.add('is-muted');
    }

    // 2. Instant Button State Sync (Anti-Flicker)
    if (cachedLoggedIn) {
      // Weekly Mode: Always GOLD if logged in (even if they played)
      [weeklyBtn, lobbyBtn].forEach(btn => {
          if (btn) {
              btn.classList.add('is-active');
              btn.classList.remove('is-disabled');
              btn.style.opacity = '1';            // ADD THIS
              btn.style.pointerEvents = 'auto';    // ADD THIS
          }
      });
      // 2. ONLY unlock if they are logged in AND haven't played
      if (!hasPlayedToday && dailyBtn) {
          dailyBtn.classList.add('is-active');
          dailyBtn.classList.remove('is-disabled');
          dailyBtn.style.opacity = '1';
          dailyBtn.style.pointerEvents = 'auto';
      }
      [shareBtn, logBtn].forEach(btn => {
        if (btn && (btn === logBtn || hasScore)) {
          btn.classList.remove('is-disabled');
          btn.style.opacity = '1';
          btn.style.pointerEvents = 'auto';
        }
      });
    } else {
      // If not logged in, ensure these stay locked 
      [dailyBtn, shareBtn, logBtn, weeklyBtn, lobbyBtn].forEach(btn => {
        if (btn) {
          btn.classList.remove('is-active'); // Remove Gold state
          btn.classList.add('is-disabled');  // Add Grey state
          btn.style.opacity = '0.5';         // Force Grey look
          btn.style.pointerEvents = 'none';  // Lock it
        }
      });
    }

    if (authBtn) authBtn.onclick = handleAuthAction;

  // Open Modal
  helpBtn.onclick = () => {
    helpModal.classList.remove('hidden');
  };

  // Close Modal (via button)
  closeHelpBtn.onclick = () => {
    helpModal.classList.add('hidden');
  };

  // Close Modal (clicking outside the box)
  window.onclick = (event) => {
    if (event.target == helpModal) {
      helpModal.classList.add('hidden');
    }
  };
    
  });
    
</script>

  <meta name="darkreader-lock">  
  <!-- OSRS Title Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- BACKGROUND LAYERS -->
  <div id="background-root">
    <div id="bg-fade-layer"></div>
  </div>

  <!-- App wrapper -->
  <div id="app">
    <div class="container">
    <button id="helpBtn" type="button">
      <span id="helpIcon" class="gold-text-icon" style="font-family: 'Cinzel', serif;">â”</span>
    </button>
      <h1 id="main-title">OSRS Trivia</h1>

      <!-- First row: User + Mute -->
      <div id="user-controls" class="row">
        <div class="icon-group">
        <button id="shareBtn" class="is-disabled" type="button" style="opacity: 0.5; pointer-events: none;">
          <span id="shareIcon">ğŸ”—</span>
        </button>
        <a href="coll-log.html" id="logBtn" class="is-disabled" style="opacity: 0.5; pointer-events: none;">
            <span id="logIcon">ğŸ†</span>
        </a>
        <button id="muteBtn" type="button">
          <span id="muteIcon"></span>
        </button>
          </div>
        <div id="userDisplay" style="display: flex; flex-direction: column; align-items: flex-start;">
          <div class="user-info-row">
            Player:<span id="usernameSpan"></span>
            <img id="equipped-pet-display" style="width:25px; height:25px; display:none; -webkit-user-drag: none; user-select: none;">
          </div>
          <div class="user-info-row">
            Level:&nbsp;<span id="levelNumber"></span> <span id="xpBracket"></span>
          </div>
        </div>
      </div>
      
      <!-- Lobby Screen -->
      <div id="lobby-screen" class="hidden">
      <h2 id="lobby-title" style="font-family: 'Cinzel', serif; color: #d4af37; text-align: center;">Live Lobby</h2>
      
      <div class="lobby-status-box" style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 8px; border: 1px solid #d4af37; margin: 20px 0;">
        <div id="player-count" style="font-size: 1.2rem; color: #f5f5f5;">Searching for players...</div>
        <div id="lobby-timer" style="font-size: 1.4rem; color: #d4af37; margin: 10px 0;">--:--</div>
        <div class="loading-spinner"></div>
        <div id="lobby-chat-container" style="background: rgba(0, 0, 0, 0.7); border: 2px solid #382418; border-radius: 4px; margin-top: 15px; height: 200px; display: flex; flex-direction: column;">
          <div id="chat-messages" style="flex-grow: 1; overflow-y: auto; padding: 10px; text-align: left; font-size: 0.9rem; font-family: sans-serif; color: #ffff00;">
              <div style="color: #d4af37;">Welcome to the live lobby!</div>
          </div>
          <div style="display: flex; border-top: 1px solid #382418;">
              <input type="text" id="chatInput" placeholder="Press Enter to chat..." maxlength="100" 
                     style="flex-grow: 1; background: transparent; border: none; color: white; padding: 8px; outline: none;">
          </div>
      </div>
      </div>
    
      <p style="opacity: 0.7; font-size: 0.8rem; color: #d4af37;">The match begins at 25 players or when the countdown ends.</p>
      
      <div class="row">
        <button id="leaveLobbyBtn" class="btn">Main Menu</button>
      </div>
    </div>
      
      <!-- Game Screen -->
      <div id="game" class="hidden">
      <div id="live-stats" style="color: #d4af37; font-family: 'Cinzel', serif; text-align: center;">
          <span id="survivor-count">Survivors: 0</span>
      </div>
        <div id="game-notifications"></div> 
        <div id="score">Score: 0</div>
        <div id="question">
          <p id="questionText"></p>
          <img id="questionImage" alt="Question image">
        </div>
        <div id="answers"></div>
        <div id="timer">
          Time: <span id="time-wrap"><span id="time">15</span>s</span>
        </div>
    </div>
       <!-- Live Mode Victory/Loss Screen -->
        <div id="victory-screen" class="hidden">
            <div class="victory-content">
                <h1 class="victory-title" id="vic-title-text">
                    <span class="emoji">ğŸ†</span> 
                    <span id="victory-status-text">VICTORY</span>
                    <span class="emoji">ğŸ†</span>
                </h1>
                <p id="victory-stats">You are the last Survivor!</p>
                <div class="match-info">
                    <span id="player-count-stat">Players: 2</span> | 
                    <span id="odds-stat">Win Odds: 50%</span>
                </div>
                <div class="victory-actions">
                    <button id="soloBtn" class="btn">Continue for High Score</button>
                    <button id="rejoinLobbyBtn" class="btn">Re-join Lobby</button>
                    <button id="victoryMainMenuBtn" class="btn">Main Menu</button>
                </div>
            </div>
        </div>
   

      <!-- Start Screen -->
      <div id="start-screen">
        <!-- First row: Start button -->
       <div class="row button-row">
        <button id="startBtn" class="btn">Normal Mode</button>
        <button id="liteBtn" class="btn">Lite Mode</button>
      </div>
      <!-- Second row: Lite mode -->
        <div class="row">
         <button id="lobbyBtn" class="btn is-disabled">Enter Lobby</button>
      </div>
        <!-- Third row: Daily mode -->
       <div class="row">
        <button id="dailyBtn" class="btn is-disabled">Daily Mode</button>
      </div>
        <!-- Forth row: Weekly mode -->
        <div class="row">
         <button id="weeklyBtn" class="btn is-disabled">Weekly Mode</button>
      </div>
        <!-- Fifth row: Login + Leaderboard -->
        <div class="row">
         <button id="authBtn" class="btn-small" onclick="handleAuthAction()">
            <span class="btn-label">Log In</span>
        </button>
          <a href="leaderboard.html" class="btn-small">Leaderboard</a>
        </div>
      </div>

      <!-- End Screen -->
      <div id="end-screen" class="hidden">
        <h2 id="game-over-title">Game Over!</h2>
        <p>Score: <span id="finalScore"></span></p>
        <div id="weeklyTimeContainer" style="display: none;">
          <p>Time: <span id="finalTime"></span></p>
        </div>
       <div id="dailyStreakContainer" style="display: none; margin-bottom: 10px;">
        <p style="color: #f5f5f5; margin: 0;">
          Current streak: <span id="streakCount">0</span>
        </p>
      </div>
        <h1 id="gz-title" class="hidden">gz</h1>
        <div class="row">
          <button id="playAgainBtn" class="btn">Play Again</button>
        </div>
        <div class="row">
          <button id="mainMenuBtn" class="btn">Main Menu</button>
        </div>
    </div>
 </div>

  <!-- Scripts #f5f5f5-->
  <script type="module" src="supabase.js"></script>
  <script type="module" src="app.js"></script>
  <script src="background.js" defer></script>

    <div id="help-modal" class="modal-overlay hidden">
  <div class="container modal-content">
    <h2 style="font-family: 'Cinzel', serif; color: #d4af37; margin-top: 0;">How to Play</h2>
    <hr style="border: 0; border-top: 1px solid #d4af37; margin-bottom: 20px;">
    
    <div class="instructions-text" style="color: #e3d7c1; text-align: left; font-size: 1rem; line-height: 1.6;">
      <p>âš”ï¸ <b>The Goal:</b> Answer OSRS trivia questions to gain XP and level up your character. Unlock pets & achievements on your way! </p>
      <p>ğŸ‘¤ <b>Accounts:</b> Create an account to access Daily and Weekly Modes, earn XP, climb the leaderboards, and claim your achievements.</p>
      <p>ğŸ›¡ï¸ <b>Normal Mode:</b> Build your score through a continuous streak of randomized questions; a single incorrect answer ends the game.</p>
      <p>âš¡ <b>Lite Mode:</b> A 100-question challenge for a quick session. a single incorrect answer ends the game.</p>
      <p>ğŸ“… <b>Daily Mode:</b> Play the daily challenge once per day to earn bonus xp. Tackle 10 random questions that are the same for everyone. </p>
      <p>ğŸƒâ€â™‚ï¸ <b>Weekly Mode:</b> Play the weekly challenge as many times as you want and improve your weekly score. Tackle 50 random questions that are the same for everyone for that week.</p>
      <p>ğŸ¥‡ <b>Leaderboard:</b> View global rankings for the highest Normal and Weekly Modes scores and total XP earned.</p>
      <p>ğŸ”— <b>Share:</b> Share your daily challenge score with your friends!</p>
      <p>ğŸ† <b>Collections:</b> View your pets and achievements.</p>
    </div>

    <button id="closeHelpBtn" class="btn" style="margin-top: 25px;">Close</button>
  </div>
</div>
    <script type="module">
    import { supabase } from './supabase.js';

// 1ï¸âƒ£ Synchronous updater: instantly updates menu pet from localStorage
function updateMenuPet(petId) {
    const petImg = document.getElementById('equipped-pet-display');
    if (!petImg) return;

    if (petId && petId !== "null") {
        const fileName = petId.replace('pet_', '') + '.png';
        petImg.src = `pets/${fileName}`;
        petImg.style.display = 'inline-block';
        petImg.style.marginLeft = '5px';
        petImg.style.verticalAlign = 'middle';
    } else {
        petImg.style.display = 'none';
    }
}

// 2ï¸âƒ£ Single function to sync with Supabase
async function syncMenuPet() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        // Logged out â†’ clear pet
        localStorage.removeItem('equipped_pet_id');
        updateMenuPet(null);
        return;
    }

    // Fetch equipped pet from Supabase once
    const { data, error } = await supabase
        .from('profiles')
        .select('equipped_pet')
        .eq('id', session.user.id)
        .single();

    if (!error && data) {
        localStorage.setItem('equipped_pet_id', data.equipped_pet);
        updateMenuPet(data.equipped_pet);
    }
}

// 3ï¸âƒ£ Setup a single real-time listener for changes
async function setupMenuPetRealtime() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    // Only one channel, one listener
    supabase
        .channel('public:profiles')
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'profiles',
            filter: `id=eq.${session.user.id}`
        }, payload => {
            const newPet = payload.new.equipped_pet;
            localStorage.setItem('equipped_pet_id', newPet);
            updateMenuPet(newPet);
        })
        .subscribe();
}

// 4ï¸âƒ£ Listen for logout directly to clear UI instantly
supabase.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_OUT') {
        localStorage.removeItem('equipped_pet_id');
        updateMenuPet(null);
    }
});

// 5ï¸âƒ£ Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Instant render from localStorage to avoid flicker
    const currentPet = localStorage.getItem('equipped_pet_id');
    updateMenuPet(currentPet);

    // Fetch fresh state from Supabase
    syncMenuPet();

    // Setup real-time listener
    setupMenuPetRealtime();
});

</script>
</body>
</html>















































































